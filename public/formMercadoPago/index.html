<link rel="stylesheet" href="../styles.css">

<style>
  #form-checkout input {
    height: 40px;
    margin-top: 8px;
  }

  #form-checkout select {
    height: 40px;
    margin-top: 8px;
  }
  
  #form-checkout button {
    height: 40px;
    line-height: 20px;
  }

  .form-checkout_inline {
    display: inline-flex;
  }  
</style>

<form id="form-checkout">
  <div class="form-checkout_inline">
      <input type="text" name="cardNumber" id="form-checkout__cardNumber" />
      <select name="issuer" id="form-checkout__issuer" style="width: 200px; margin-left: 5px;" disabled></select>
  </div>
  <input type="text" name="cardholderName" id="form-checkout__cardholderName"/>
  <div class="form-checkout_inline">
    <input type="text" name="cardExpirationDate" id="form-checkout__cardExpirationDate" />
    <input type="text" name="securityCode" id="form-checkout__securityCode" style="margin-left: 5px;" />
  </div>  
  <select name="installments" id="form-checkout__installments"></select>
  <div class="form-checkout_inline">
    <select name="identificationType" id="form-checkout__identificationType" style="width: 200px;"></select>
    <input type="text" name="identificationNumber" id="form-checkout__identificationNumber" style="margin-left: 5px;"/>
  </div>  
  <button type="submit" id="form-checkout__submit" class="button">Iniciar Pedido</button>
</form>

<script src="https://sdk.mercadopago.com/js/v2"></script>

<script>
  const carrinho = JSON.parse(localStorage.getItem('carrinho'));
  const keyMercadoPago = localStorage.getItem('keyMercadoPago');
  const apiBaseUrl = localStorage.getItem('apiBaseUrl');

  const mp = new MercadoPago(keyMercadoPago);

  const cardForm = mp.cardForm({
    amount: carrinho.valorTotal.toString(),
    autoMount: true,
    form: {
      id: "form-checkout",
      cardholderName: {
        id: "form-checkout__cardholderName",
        placeholder: "Titular do cartão",
      },
      cardNumber: {
        id: "form-checkout__cardNumber",
        placeholder: "Número do cartão",
      },
      cardExpirationDate: {
        id: "form-checkout__cardExpirationDate",
        placeholder: "MM/AAAA",
      },
      securityCode: {
        id: "form-checkout__securityCode",
        placeholder: "CVV",
      },
      installments: {
        id: "form-checkout__installments",
        placeholder: "Parcelas",
      },        
      issuer: {
        id: "form-checkout__issuer",
        placeholder: "Banco emissor",
      },
      identificationType: {
        id: "form-checkout__identificationType",
        placeholder: "Tipo de documento",
      },
      identificationNumber: {
        id: "form-checkout__identificationNumber",
        placeholder: "Número do documento",
      },
    },
    callbacks: {
      onFormMounted: error => {
        if (error) return console.warn("Form Mounted handling error: ", error);
        console.log("Form mounted");
      }, 
      onSubmit: event => {
        event.preventDefault();

        const data = {
          paymentMethodId: payment_method_id,
          issuerId: issuer_id,          
          amount,
          token,
          installments,
          identificationNumber,
          identificationType,
        } = cardForm.getCardFormData();     

        iniciarPedido(data);
      }
    }
  });

  async function iniciarPedido(dadosPagamento) {
    event.preventDefault();

    const loginUsuario = localStorage.getItem('login');
    const token = localStorage.getItem('accessToken'); 

    var cardholderName =  document.getElementById('form-checkout__cardholderName').value;
    var cardNumber = document.getElementById('form-checkout__cardNumber').value;
    var cardExpirationDate= document.getElementById('form-checkout__cardExpirationDate').value;
    var securityCode = document.getElementById('form-checkout__securityCode').value;

    const response = await fetch(
      `${apiBaseUrl}/api/v1/Carrinho/iniciar-pedido`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          pedidoId: carrinho.pedidoId,
          clienteId: carrinho.usuarioId,
          clienteLogin: loginUsuario,
          valorTotal: carrinho.valorTotal,
          items: carrinho.items,
          pagamento: {
            nomeCartao: cardholderName,
            numeroCartao: cardNumber,
            expiracaoCartao: cardExpirationDate,
            cvvCartao: securityCode,
            parcelas: dadosPagamento.installments,
            tokenCard: dadosPagamento.token,
            paymentMethodId: dadosPagamento.paymentMethodId
          }     
        })
      }
    );

    const dadosResponse = await response.json();

    if(response.ok) {
      localStorage.removeItem('carrinho');
      localStorage.removeItem('keyMercadoPago');
      localStorage.removeItem('apiBaseUrl');
    }
  }
</script>